name: NanoBot Educational Release
on:
  push:
    branches:
      - main

jobs:
  educational-safety-validation:
    name: Educational Safety Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: 22
      - name: Install bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ secrets.BUN_VERSION }}
      - name: Install deps
        run: bun i
      - name: Run Educational Safety Validation
        run: bun run test:safety:complete
      - name: Validate Age-Appropriate Content
        run: bun run validate:content:k12

  release:
    name: Educational Release
    runs-on: ubuntu-latest
    needs: educational-safety-validation

    services:
      postgres:
        image: paradedb/paradedb:latest
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready --health-interval 10s --health-timeout 5s  --health-retries 5


        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v5
        with:
          token: ${{ secrets.GH_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: 22
          package-manager-cache: false

      - name: Install bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ secrets.BUN_VERSION }}

      - name: Install deps
        run: bun i

      - name: Lint
        run: bun run lint

      - name: Test Database Coverage
        run: bun run --filter @lobechat/database test
        env:
          DATABASE_TEST_URL: postgresql://postgres:postgres@localhost:5432/postgres
          DATABASE_DRIVER: node
          NEXT_PUBLIC_SERVICE_MODE: server
          KEY_VAULTS_SECRET: LA7n9k3JdEcbSgml2sxfw+4TV1AzaaFU5+R176aQz4s=
          S3_PUBLIC_DOMAIN: https://example.com
          APP_URL: https://home.com

      - name: Test App
        run: bun run test-app

      - name: Release
        run: bun run release
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Workflow
        run: bun run workflow:readme

      - name: Commit Educational Updates
        run: |-
          git diff
          git config --global user.name "nanobotai"
          git config --global user.email "hello@rgknow.com"
          git add .
          git commit -m "ï¿½ docs(bot): Auto sync educational agents & plugins" || exit 0
          git push
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
