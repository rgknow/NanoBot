name: Educational Security & Compliance

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # Run comprehensive security scan weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'

permissions:
  contents: read
  security-events: write
  issues: write

jobs:
  educational-dependency-audit:
    name: Educational Dependency Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: 22

      - name: Install bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ secrets.BUN_VERSION }}

      - name: Install dependencies
        run: bun install

      - name: Run Educational Package Audit
        run: |
          echo "ðŸ” Auditing educational platform dependencies..."
          bun audit --audit-level moderate
          
      - name: Check for Educational-Specific Vulnerabilities
        run: |
          echo "ðŸ›¡ï¸ Checking for educational platform vulnerabilities..."
          bun run security:scan:educational

      - name: Validate Safe Dependencies for K-12
        run: |
          echo "ðŸ‘¨â€ðŸŽ“ Validating dependencies are safe for K-12 education..."
          bun run validate:dependencies:k12

  coppa-compliance-check:
    name: COPPA Compliance Validation
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: 22

      - name: Install bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ secrets.BUN_VERSION }}

      - name: Install dependencies
        run: bun install

      - name: Validate COPPA Data Collection Policies
        run: |
          echo "ðŸ‘¶ Validating COPPA compliance for children under 13..."
          bun run compliance:coppa:validate

      - name: Check Parental Consent Mechanisms
        run: |
          echo "ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ Checking parental consent systems..."
          bun run test:parental:consent

      - name: Audit Student Data Handling
        run: |
          echo "ðŸ“Š Auditing student data collection and storage..."
          bun run audit:student:data

      - name: Validate Data Minimization
        run: |
          echo "ðŸ”’ Validating minimal data collection practices..."
          bun run validate:data:minimization

  ferpa-compliance-check:
    name: FERPA Compliance Validation
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: 22

      - name: Install bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ secrets.BUN_VERSION }}

      - name: Install dependencies
        run: bun install

      - name: Validate Educational Record Privacy
        run: |
          echo "ðŸ« Validating FERPA educational record privacy..."
          bun run compliance:ferpa:validate

      - name: Check Student Directory Information Controls
        run: |
          echo "ðŸ“‹ Checking student directory information controls..."
          bun run test:directory:controls

      - name: Audit Educational Record Access
        run: |
          echo "ðŸ” Auditing educational record access controls..."
          bun run audit:record:access

      - name: Validate Consent for Educational Records
        run: |
          echo "âœ… Validating consent mechanisms for educational records..."
          bun run validate:educational:consent

  gdpr-compliance-check:
    name: GDPR Compliance for Global Education
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: 22

      - name: Install bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ secrets.BUN_VERSION }}

      - name: Install dependencies
        run: bun install

      - name: Validate GDPR Data Processing
        run: |
          echo "ðŸ‡ªðŸ‡º Validating GDPR compliance for European students..."
          bun run compliance:gdpr:validate

      - name: Check Right to Deletion
        run: |
          echo "ðŸ—‘ï¸ Checking right to deletion mechanisms..."
          bun run test:right:deletion

      - name: Audit Data Portability
        run: |
          echo "ðŸ“¦ Auditing data portability features..."
          bun run audit:data:portability

      - name: Validate Consent Management
        run: |
          echo "ðŸ“ Validating GDPR consent management..."
          bun run validate:gdpr:consent

  educational-penetration-testing:
    name: Educational Platform Penetration Testing
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: 22

      - name: Install bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ secrets.BUN_VERSION }}

      - name: Install dependencies
        run: bun install

      - name: Test Authentication Security
        run: |
          echo "ðŸ” Testing authentication security..."
          bun run pentest:auth

      - name: Test Student Data Protection
        run: |
          echo "ðŸ‘¨â€ðŸŽ“ Testing student data protection..."
          bun run pentest:student:data

      - name: Test Role-Based Access Controls
        run: |
          echo "ðŸ‘¥ Testing role-based access controls..."
          bun run pentest:rbac

      - name: Test API Security for Educational Endpoints
        run: |
          echo "ðŸ”Œ Testing API security for educational endpoints..."
          bun run pentest:api:educational

      - name: Test Input Validation and Sanitization
        run: |
          echo "ðŸ§¹ Testing input validation and sanitization..."
          bun run pentest:input:validation

  educational-codeql-analysis:
    name: Educational CodeQL Security Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    
    steps:
      - uses: actions/checkout@v5

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript,typescript
          queries: +security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript"

  educational-license-compliance:
    name: Educational License Compliance
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: 22

      - name: Install bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ secrets.BUN_VERSION }}

      - name: Install dependencies
        run: bun install

      - name: Check Educational License Compatibility
        run: |
          echo "ðŸ“„ Checking license compatibility for educational use..."
          bun run license:check:educational

      - name: Validate Open Source License Compliance
        run: |
          echo "âš–ï¸ Validating open source license compliance..."
          bun run license:compliance:validate

      - name: Generate License Report
        run: |
          echo "ðŸ“Š Generating license compliance report..."
          bun run license:report:generate

  security-reporting:
    name: Educational Security Reporting
    runs-on: ubuntu-latest
    needs: [educational-dependency-audit, coppa-compliance-check, ferpa-compliance-check, gdpr-compliance-check, educational-penetration-testing, educational-codeql-analysis, educational-license-compliance]
    if: always()
    
    steps:
      - uses: actions/checkout@v5

      - name: Generate Comprehensive Security Report
        run: |
          echo "ðŸ“‹ Generating comprehensive educational security report..."
          echo "## Educational Platform Security Summary" > security-report.md
          echo "- COPPA Compliance: ${{ needs.coppa-compliance-check.result }}" >> security-report.md
          echo "- FERPA Compliance: ${{ needs.ferpa-compliance-check.result }}" >> security-report.md
          echo "- GDPR Compliance: ${{ needs.gdpr-compliance-check.result }}" >> security-report.md
          echo "- Dependency Audit: ${{ needs.educational-dependency-audit.result }}" >> security-report.md
          echo "- Penetration Testing: ${{ needs.educational-penetration-testing.result }}" >> security-report.md
          echo "- Code Analysis: ${{ needs.educational-codeql-analysis.result }}" >> security-report.md
          echo "- License Compliance: ${{ needs.educational-license-compliance.result }}" >> security-report.md

      - name: Upload Security Report
        uses: actions/upload-artifact@v4
        with:
          name: educational-security-report
          path: security-report.md
          retention-days: 90

      - name: Notify Security Team
        if: contains(needs.*.result, 'failure')
        run: |
          echo "ðŸš¨ Security compliance issues detected in educational platform"
          echo "Review required before deployment to educational environments"
          exit 1